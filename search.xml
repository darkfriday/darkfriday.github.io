<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Auditbeat_install@CentOS8</title>
    <url>/2020/11/10/Auditbeat-install/</url>
    <content><![CDATA[<h1 id="x1f4e6-Auditbeat-install-CentOS8"><a href="#x1f4e6-Auditbeat-install-CentOS8" class="headerlink" title="&#x1f4e6;Auditbeat_install@CentOS8 "></a><center><span class="github-emoji" alias="package" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e6.png?v8">&#x1f4e6;</span>Auditbeat_install@CentOS8 </center></h1><h6 id="tags-dnf-beats-centos-el8"><a href="#tags-dnf-beats-centos-el8" class="headerlink" title="tags: dnf, beats, centos , el8"></a>tags: <code>dnf</code>, <code>beats</code>, <code>centos</code> , <code>el8</code></h6><h3 id="Download-elastic-repo-GPG-key"><a href="#Download-elastic-repo-GPG-key" class="headerlink" title="Download elastic repo GPG key"></a>Download elastic repo GPG key</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="Create-repo-in-etc-yum-repos-d"><a href="#Create-repo-in-etc-yum-repos-d" class="headerlink" title="Create .repo in /etc/yum.repos.d/"></a>Create <code>.repo</code> in <code>/etc/yum.repos.d/</code></h3><figure class="highlight plain"><figcaption><span>/etc/yum.repos.d/elastic.repo</span></figcaption><table><tr><td class="code"><pre><span class="line">[elastic-7.x]</span><br><span class="line">name&#x3D;Elastic repository for 7.x packages</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;packages&#x2F;7.x&#x2F;yum</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;GPG-KEY-elasticsearch</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">autorefresh&#x3D;1</span><br><span class="line">type&#x3D;rpm-md</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<ul>
<li>dnf install auditbeat<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf install auditbeat</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Configure-automatiically-during-boot"><a href="#Configure-automatiically-during-boot" class="headerlink" title="Configure automatiically during boot"></a>Configure automatiically during boot</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> auditbeat</span><br><span class="line">$ sudo systemctl start auditbeat</span><br></pre></td></tr></table></figure>
<h3 id="Modify-output-IP-address-amp-configure-mem-queue-size"><a href="#Modify-output-IP-address-amp-configure-mem-queue-size" class="headerlink" title="Modify output IP address &amp; configure mem queue size"></a>Modify output IP address &amp; configure mem queue size</h3><p>注意網段<code>.1</code> or <code>.2</code></p>
<div class="tabs" id="unique-name"><ul class="nav-tabs"><li class="tab active"><a href="#unique-name-1">.1網段</a></li><li class="tab"><a href="#unique-name-2">.2網段</a></li></ul><div class="tab-content"><div class="tab-pane active" id="unique-name-1"><figure class="highlight yaml"><figcaption><span>/etc/aduitbeat/aduitbeat.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.10.1.247:9200&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">queue.mem:</span></span><br><span class="line">  <span class="attr">events:</span> <span class="number">1024</span></span><br><span class="line">  <span class="attr">flush.min_events:</span> <span class="number">512</span></span><br><span class="line">  <span class="attr">flush.timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="unique-name-2"><figure class="highlight yaml"><figcaption><span>/etc/aduitbeat/aduitbeat.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.10.2.247:9200&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">queue.mem:</span></span><br><span class="line">  <span class="attr">events:</span> <span class="number">1024</span></span><br><span class="line">  <span class="attr">flush.min_events:</span> <span class="number">512</span></span><br><span class="line">  <span class="attr">flush.timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure></div></div></div>

<p>Plus: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9iZWF0cy9hdWRpdGJlYXQvY3VycmVudC9ydW5uaW5nLW9uLWRvY2tlci5odG1s">Run auditbeat on Docker<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>Dnf</tag>
        <tag>Beats</tag>
        <tag>CentOS</tag>
        <tag>EL8</tag>
      </tags>
  </entry>
  <entry>
    <title>CoreDNS 安裝教學 in Centos8</title>
    <url>/2020/11/10/CoreDNS-%E5%AE%89%E8%A3%9D%E6%95%99%E5%AD%B8-in-Centos8-Docker/</url>
    <content><![CDATA[<h1 id="x2693-CoreDNS-安裝教學-in-Centos8-x1f433-Docker"><a href="#x2693-CoreDNS-安裝教學-in-Centos8-x1f433-Docker" class="headerlink" title="&#x2693;CoreDNS 安裝教學 in Centos8(&#x1f433;Docker)"></a><center><span class="github-emoji" alias="anchor" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2693.png?v8">&#x2693;</span>CoreDNS 安裝教學 in Centos8(<span class="github-emoji" alias="whale" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f433.png?v8">&#x1f433;</span>Docker)</center></h1><h6 id="tags-coreDNS-docker-centos-el8"><a href="#tags-coreDNS-docker-centos-el8" class="headerlink" title="tags: coreDNS docker centos el8"></a>tags: <code>coreDNS</code> <code>docker</code> <code>centos</code> <code>el8</code></h6><h2 id="安裝Docker"><a href="#安裝Docker" class="headerlink" title="安裝Docker"></a>安裝Docker</h2><ul>
<li><p><code>step 1</code> Add docker repo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 2</code> Installing docker-ce 相關依賴套件</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> buildah</li>
<li><input checked="" disabled="" type="checkbox"> podman</li>
<li><input disabled="" type="checkbox"> containerd.io &gt; 1.2.0-3.el7<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf -y install buildah &amp;&amp; dnf -y install podman</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>step 2.5</strong> Manual Installing containerd.io</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">版本號 1.2.13-3.2 可更換最新的 </span><br><span class="line">$ sudo dnf -y install https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<a id="more"></a>
</li>
<li><p><code>step 3</code> Installing docker-ce</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf -y install docker-ce</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>step 4</code> 關閉防火牆(會造成docker內部橋接網路不通)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 5</code> Start and enable the docker daemon</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">設定為daemon啟動</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line"></span><br><span class="line">檢查是否啟動</span><br><span class="line">$ sudo systemctl is-active docker</span><br><span class="line"></span><br><span class="line">檢查是否自動啟動</span><br><span class="line">$ sudo systemctl is-enabled docker</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 6</code> Installing docker-compose（手動方式）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">下載可執行檔案 1.27.0-rc3 可更換最新的</span><br><span class="line">$ curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.27.0-rc3/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o docker-compose</span><br><span class="line">加可執行and傳到/usr/<span class="built_in">local</span>/bin底下</span><br><span class="line">$ sudo mv docker-compose /usr/<span class="built_in">local</span>/bin &amp;&amp; sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>:::info<br>==番外== testing docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run --rm --name=linuxconfig-test -p 80:80 httpd </span><br><span class="line">如果成功用瀏覽器在自己的ip打開 會看到it<span class="string">&#x27;s work!</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker rmi httpd</span><br><span class="line">刪除測試用httpd</span><br></pre></td></tr></table></figure>
<p>:::</p>
</li>
</ul>
<h2 id="安裝CoreDNS"><a href="#安裝CoreDNS" class="headerlink" title="安裝CoreDNS"></a>安裝CoreDNS</h2><ul>
<li><p><code>step 1</code> dockerhub 上抓coredn的映像檔</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker pull coredns/coredns</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 2</code> config coredns </p>
<ul>
<li><input checked="" disabled="" type="checkbox"> docker-compose.yml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo mkdir -p docker/coredns/config &amp;&amp; <span class="built_in">cd</span> docker/coredns &amp;&amp; vim docker-compose.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">coredns:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">coredns/coredns:latest</span></span><br><span class="line">      <span class="attr">container_name:</span> <span class="string">coredns</span></span><br><span class="line">      <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">expose:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53/udp&#x27;</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53:53&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53:53/udp&#x27;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;$PWD/config/:/etc/coredns/&#x27;</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;-conf&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;/etc/coredns/Corefile&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><input checked="" disabled="" type="checkbox"> Corefile<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vim config/Corefile</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">.:<span class="number">53</span> &#123;</span><br><span class="line">    forward . <span class="number">8.8</span>.<span class="number">8.8</span>:<span class="number">53</span></span><br><span class="line">    <span class="built_in">log</span></span><br><span class="line">    errors</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mis &#123;</span><br><span class="line">    <span class="keyword">file</span> /etc/coredns/mis</span><br><span class="line">    <span class="built_in">log</span></span><br><span class="line">    errors</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><input checked="" disabled="" type="checkbox"> mis<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vim config/mis</span><br></pre></td></tr></table></figure>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line"><span class="meta">$TTL</span> <span class="number">10</span></span><br><span class="line">@     <span class="keyword">IN</span>  <span class="keyword">SOA</span>     ns1.service. root.ns.service. (</span><br><span class="line">            <span class="number">2</span>   <span class="comment">;serial</span></span><br><span class="line">            <span class="number">300</span> <span class="comment">; refresh</span></span><br><span class="line">            <span class="number">1800</span> <span class="comment">; retry</span></span><br><span class="line">            <span class="number">10</span>  <span class="comment">; expire</span></span><br><span class="line">            <span class="number">300</span> <span class="comment">; minimum</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">;name servers</span></span><br><span class="line">@       <span class="keyword">IN</span>      <span class="keyword">NS</span>      ns1.service.</span><br><span class="line">ns1.service.    <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">10.20.10.246</span></span><br><span class="line">vcsa   <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.200</span></span><br><span class="line">esxi201 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.201</span></span><br><span class="line">esxi202 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.202</span></span><br><span class="line">esxi203 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.203</span></span><br><span class="line">esxi204 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.204</span></span><br><span class="line">esxi205 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.205</span></span><br><span class="line">esxi206 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.206</span></span><br><span class="line">esxi207 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.207</span></span><br><span class="line">esxi208 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.208</span></span><br><span class="line">esxi209 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.209</span></span><br><span class="line">esxi210 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.210</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>step 3</code> Run docker-compose </p>
</li>
</ul>
<p>enable</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>restart</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker-compose restart coredns</span><br><span class="line">or</span><br><span class="line">$ sudo docker restart coredns</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>CentOS</tag>
        <tag>EL8</tag>
        <tag>Docker</tag>
        <tag>Coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>ELK完全安裝手冊</title>
    <url>/2021/02/05/ELK%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%A7%8B/</url>
    <content><![CDATA[<h6 id="tags-elk-elastic-logstash-kibana"><a href="#tags-elk-elastic-logstash-kibana" class="headerlink" title="tags: elk elastic logstash kibana"></a>tags: <code>elk</code> <code>elastic</code> <code>logstash</code> <code>kibana</code></h6><h1 id="x1f4b9-ELK完全安裝手冊"><a href="#x1f4b9-ELK完全安裝手冊" class="headerlink" title=" &#x1f4b9;ELK完全安裝手冊"></a><center> <span class="github-emoji" alias="chart" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4b9.png?v8">&#x1f4b9;</span>ELK完全安裝手冊</center></h1><p>XXXbeat = <code>事件發送裝置</code><br>Logstash = <code>事件處理裝置</code><br>Elasticsearchs = <code>搜索引擎</code><br>Gafana,Kibana = <code>使用者瀏覽+操作介面端</code><br>配合 <span class="exturl" data-url="aHR0cDovLzEwLjEwLjEwLjI0NDozMDAwL1VuenpiUXQ3UVBHSDB3UWRCc2NNbXc=">ELK安全性<i class="fa fa-external-link-alt"></i></span> 可以得知中間每一條虛線都可以加密,且圍繞著Elasticsearch有帳密驗證<br>事件如果不需要==額外==處理,可以直接跳過事件處理裝置直接送到搜索引擎</p>
<hr>
<p><font color="red">紅色GET</font><br><font color="blue">藍色POST</font></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">digraph ELK &#123; </span><br><span class="line">fontsize &#x3D; 14;</span><br><span class="line">nodesep&#x3D;0.6</span><br><span class="line">edge [color&#x3D;Blue,style&#x3D;dashed]</span><br><span class="line">node [fontname&#x3D;Courier,shape&#x3D;record,color&#x3D;&quot;skyblue&quot;, style&#x3D;&quot;filled&quot;]</span><br><span class="line"></span><br><span class="line">subgraph cluster_shiper&#123;</span><br><span class="line">label&#x3D;&quot;線上機器&#39;s&quot;;</span><br><span class="line">bgcolor&#x3D;&quot;mintcream&quot;;</span><br><span class="line">Filebeat;</span><br><span class="line">Auditbeat</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">subgraph cluster_es&#123;</span><br><span class="line">label&#x3D;&quot;ES_clusters&quot;;</span><br><span class="line">bgcolor&#x3D;&quot;mintcream&quot;;</span><br><span class="line">Elasticsearchs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Elasticsearchs[style&#x3D;&quot;filled&quot;,fillcolor&#x3D;&quot;yellow&quot;]</span><br><span class="line">Browser[style&#x3D;&quot;filled&quot;,fillcolor&#x3D;&quot;green&quot;]</span><br><span class="line">Logstash[style&#x3D;&quot;filled&quot;,fillcolor&#x3D;&quot;orange&quot;]</span><br><span class="line">Kibana[style&#x3D;&quot;filled&quot;,fillcolor&#x3D;&quot;red&quot;]</span><br><span class="line">Gafana[style&#x3D;&quot;filled&quot;,fillcolor&#x3D;&quot;brown&quot;]</span><br><span class="line"></span><br><span class="line">Elasticsearchs-&gt;Elasticsearchs[color&#x3D;&quot;green&quot;][label&#x3D;&quot;9300&quot;];</span><br><span class="line">Logstash-&gt;Elasticsearchs[label&#x3D;&quot;9200&quot;];</span><br><span class="line">Filebeat-&gt;Logstash[label&#x3D;&quot;5044&quot;];</span><br><span class="line">syslog_client-&gt;Logstash[label&#x3D;&quot;5041-5045&quot;];    </span><br><span class="line">Filebeat-&gt;Elasticsearchs[label&#x3D;&quot;9200&quot;];</span><br><span class="line">Auditbeat-&gt;Elasticsearchs[label&#x3D;&quot;9200&quot;];</span><br><span class="line">Kibana-&gt;Elasticsearchs;</span><br><span class="line">Elasticsearchs-&gt;Kibana[color&#x3D;&quot;red&quot;][label&#x3D;&quot;RESTful 9200&quot;];</span><br><span class="line">Elasticsearchs-&gt;Gafana[color&#x3D;&quot;red&quot;][label&#x3D;&quot;9200&quot;]</span><br><span class="line">Kibana-&gt;Browser[color&#x3D;&quot;red&quot;][label&#x3D;&quot;https 5061&quot;]</span><br><span class="line">Gafana-&gt;Browser[color&#x3D;&quot;red&quot;][label&#x3D;&quot;http 3000&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<a id="more"></a>

<h3 id="Elastic-Stack-License"><a href="#Elastic-Stack-License" class="headerlink" title="Elastic Stack License"></a>Elastic Stack License</h3><p>ELK7版以後內建有基本的安全性設定及部分額外功能，額外功能都需綁定開啟安全性。因此強烈推薦開啟安全性設定。<br>文章內使用到的為Basic版開啟認證系統節點中通訊加密採用 SSL</p>
<h4 id="有關版本差異"><a href="#有關版本差異" class="headerlink" title="有關版本差異"></a>有關版本差異</h4><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9zdWJzY3JpcHRpb25z">X-Packs<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="安裝-Elasticsearchs"><a href="#安裝-Elasticsearchs" class="headerlink" title="安裝 Elasticsearchs"></a>安裝 Elasticsearchs</h3><table>
<thead>
<tr>
<th>IP1</th>
<th>IP2</th>
<th>Http Port（ES HTTP API）</th>
<th>Transport Port（ES叢集内部通信用）</th>
<th>nodename</th>
</tr>
</thead>
<tbody><tr>
<td>10.10.9.247</td>
<td>10.20.30.247</td>
<td>9200</td>
<td>9300</td>
<td>tribe-node</td>
</tr>
<tr>
<td>10.10.9.47</td>
<td>10.20.30.47</td>
<td>9200</td>
<td>9300</td>
<td>node-1</td>
</tr>
<tr>
<td>10.10.9.48</td>
<td>10.20.30.48</td>
<td>9200</td>
<td>9300</td>
<td>node-2</td>
</tr>
<tr>
<td>10.10.9.49</td>
<td>10.20.30.49</td>
<td>9200</td>
<td>9300</td>
<td>node-3</td>
</tr>
<tr>
<td>10.10.9.50</td>
<td>10.20.30.50</td>
<td>9200</td>
<td>9300</td>
<td>node-4</td>
</tr>
<tr>
<td>10.10.9.51</td>
<td>10.20.30.51</td>
<td>9200</td>
<td>9300</td>
<td>node-5</td>
</tr>
<tr>
<td>10.10.9.52</td>
<td>10.20.30.52</td>
<td>9200</td>
<td>9300</td>
<td>node-6</td>
</tr>
</tbody></table>
<ul>
<li><input disabled="" type="checkbox"> <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VsYXN0aWMvYW5zaWJsZS1lbGFzdGljc2VhcmNo">ansible<i class="fa fa-external-link-alt"></i></span></li>
<li><input disabled="" type="checkbox"> <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L2RvY2tlci5odG1s">docker<i class="fa fa-external-link-alt"></i></span></li>
<li><input checked="" disabled="" type="checkbox"> <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3JwbS5odG1s">dnf-RPM<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>下載匯入PGP Key</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">rpm --<span class="keyword">import</span> <span class="attr">https:</span><span class="comment">//artifacts.elastic.co/GPG-KEY-elasticsearch</span></span><br></pre></td></tr></table></figure>

<p>新增elastic stack repo <code>/etc/yum.repos.d/elastic.repo</code></p>
<figure class="highlight plain"><figcaption><span>/etc/yum.repos.d/</span></figcaption><table><tr><td class="code"><pre><span class="line">[elasticsearch]</span><br><span class="line">name&#x3D;Elasticsearch repository for 7.x packages</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;packages&#x2F;7.x&#x2F;yum</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;GPG-KEY-elasticsearch</span><br><span class="line">enabled&#x3D;0</span><br><span class="line">autorefresh&#x3D;1</span><br><span class="line">type&#x3D;rpm-md</span><br></pre></td></tr></table></figure>

<p>啟用repo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo dnf install --enablerepo=elasticsearch elasticsearch</span><br></pre></td></tr></table></figure>

<p>systemd enable</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /bin/systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> elasticsearch.service</span><br><span class="line">sudo systemctl start elasticsearch.service</span><br></pre></td></tr></table></figure>

<h3 id="系統設定"><a href="#系統設定" class="headerlink" title="系統設定"></a>系統設定</h3><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3N5c3RlbS1jb25maWcuaHRtbA==">https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html<i class="fa fa-external-link-alt"></i></span></p>
<h4 id="Disable-swapping"><a href="#Disable-swapping" class="headerlink" title="Disable swapping"></a>Disable swapping</h4><ul>
<li>Disable all swap files   <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo swapoff -a</span><br><span class="line">sudo vim /etc/fstab <span class="comment">#掉swap mount的部分</span></span><br></pre></td></tr></table></figure></li>
<li>Enable bootstrap.memory_lock in <code>elasticsearch.yml</code>  <figure class="highlight yaml"><figcaption><span>elasticsearch.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li>ulimits <code>/etc/security/limits.conf</code>  <figure class="highlight plain"><figcaption><span>/etc/security/limits.conf</span></figcaption><table><tr><td class="code"><pre><span class="line"># allow user &#39;elasticsearch&#39; mlockall</span><br><span class="line">elasticsearch soft memlock unlimited</span><br><span class="line">elasticsearch hard memlock unlimited</span><br></pre></td></tr></table></figure>
<h4 id="Increase-file-descriptors"><a href="#Increase-file-descriptors" class="headerlink" title="Increase file descriptors"></a>Increase file descriptors</h4></li>
<li>ulimits <code>/etc/security/limits.conf</code>  <figure class="highlight plain"><figcaption><span>/etc/security/limits.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">elasticsearch  -  nofile  65535</span><br></pre></td></tr></table></figure>
<h4 id="Ensure-sufficient-virtual-memory"><a href="#Ensure-sufficient-virtual-memory" class="headerlink" title="Ensure sufficient virtual memory"></a>Ensure sufficient virtual memory</h4></li>
<li>sysctl <code>/etc/sysctl.conf</code>  <figure class="highlight plain"><figcaption><span>/etc/sysctl.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">vm.swappiness&#x3D;1</span><br><span class="line">vm.max_map_count&#x3D;262144</span><br></pre></td></tr></table></figure>
  <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>
<h4 id="Ensure-sufficient-threads"><a href="#Ensure-sufficient-threads" class="headerlink" title="Ensure sufficient threads"></a>Ensure sufficient threads</h4></li>
<li>ulimits <code>/etc/security/limits.conf</code>  <figure class="highlight plain"><figcaption><span>/etc/security/limits.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">elasticsearch  -  nproc  4096</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Elasticsearch-基礎概念"><a href="#Elasticsearch-基礎概念" class="headerlink" title="Elasticsearch 基礎概念"></a>Elasticsearch 基礎概念</h3><h4 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h4><p>叢集 由一台或多台的Elasticsearch 節點(Node)組成</p>
<h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h4><p>節點 即為Elasticsearch的服務本身 同一台機器上啟動兩個Elasticsearch服務(docker or 不同port) 就是兩個node</p>
<h4 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h4><p>索引 具有相同結構的文檔集合體 類似關連式database本身 每一個節點內可以有多個索引</p>
<h4 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h4><p>文檔 Elasticsearch中最小的儲存單元 JSON數據格式 複數Document組合而成索引 文檔類似關聯式database中表內一筆記錄。</p>
<h4 id="Shard"><a href="#Shard" class="headerlink" title="Shard"></a>Shard</h4><p>分片又稱Primary shard<br>單個索引切分成多個shard，分佈在多台Node節點上存儲。可以利用shard很好的橫向擴展，以存儲更多的數據，同時shard分佈在多台node上，可以提升集群整體的吞吐量和性能。在創建索引的時候可以直接指定分片的數量即可，一旦指定就不能再修改了。</p>
<h4 id="Replica"><a href="#Replica" class="headerlink" title="Replica"></a>Replica</h4><p>分片副本又稱Replica shard<br>跟主shard的內容一樣 一個shard可以有一個或者多個replica 作用是同主分片一同分散在各節點內以提高冗餘並增加讀搜尋速度(類似raid的概念)</p>
]]></content>
      <categories>
        <category>tech</category>
      </categories>
      <tags>
        <tag>EL8</tag>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearch API 範例</title>
    <url>/2020/11/18/Elasticsearch-API-%E7%AF%84%E4%BE%8B/</url>
    <content><![CDATA[<h1 id="x1f4ab-Elasticsearch-API-範例"><a href="#x1f4ab-Elasticsearch-API-範例" class="headerlink" title=" &#x1f4ab;Elasticsearch API 範例 "></a><center> <span class="github-emoji" alias="dizzy" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ab.png?v8">&#x1f4ab;</span>Elasticsearch API 範例 </center></h1><h3 id="Rolling-upgrade"><a href="#Rolling-upgrade" class="headerlink" title="Rolling upgrade"></a>Rolling upgrade</h3><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3JvbGxpbmctdXBncmFkZXMuaHRtbA==">https://www.elastic.co/guide/en/elasticsearch/reference/current/rolling-upgrades.html<i class="fa fa-external-link-alt"></i></span></p>
<p>dev_tools: http://&lt;$kibana_server&gt;/app/dev_tools#/console</p>
<h4 id="1-get-cluseter-node-info"><a href="#1-get-cluseter-node-info" class="headerlink" title="1. get cluseter node info"></a>1. get cluseter node info</h4><p>根據節點分組 優先處理非master的節點</p>
<figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">GET /_nodes/_all,master:<span class="literal">false</span>?pretty&amp;flat_settings</span><br><span class="line">GET /_nodes/master:<span class="literal">true</span>?pretty&amp;flat_settings</span><br><span class="line">GET _cluster/settings?pretty&amp;flat_settings</span><br></pre></td></tr></table></figure>

<h4 id="2-disabele-node-allocation-amp-flush-synced"><a href="#2-disabele-node-allocation-amp-flush-synced" class="headerlink" title="2. disabele node allocation &amp; flush synced"></a>2. disabele node allocation &amp; flush synced</h4><p>只允許自動分配主要shard 不分配replicate </p>
<figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.enable&quot;</span>: <span class="string">&quot;primaries&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST _flush</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<p>然後開始停服務升級 自行操作 這邊只說api的部分 <code>這邊要注意 有一台會是kibana連接的es(除非用domain 並做輪替詢問之類的HA機制)</code> </p>
<h4 id="3-enabele-node-allocation-amp-recovery-shards-status"><a href="#3-enabele-node-allocation-amp-recovery-shards-status" class="headerlink" title="3. enabele node allocation &amp; recovery shards status"></a>3. enabele node allocation &amp; recovery shards status</h4><p>升級完畢開回自動分配 並查看後續shards回復狀態(到全綠色)</p>
<figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.enable&quot;</span>: null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET _cat/recovery</span><br></pre></td></tr></table></figure>

<h4 id="4-get-info-after-rolling-upgrade"><a href="#4-get-info-after-rolling-upgrade" class="headerlink" title="4. get info after rolling upgrade"></a>4. get info after rolling upgrade</h4><p>其他查看節點升級狀態的api</p>
<figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">GET _cat/nodes</span><br><span class="line">GET _cat/health?v</span><br><span class="line">GET /_cat/nodes?h=ip,name,version&amp;v</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Cluster-troubleshooting"><a href="#Cluster-troubleshooting" class="headerlink" title="Cluster troubleshooting"></a>Cluster troubleshooting</h3><figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">GET _cluster/health?level=indices</span><br><span class="line">GET _cluster/health?level=shards</span><br><span class="line">GET _cluster/health/nginx-log-<span class="number">2020.06</span>.<span class="number">18</span>-<span class="number">000742</span>?level=shards</span><br><span class="line">GET _cluster/allocation/explain</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Set-watermark"><a href="#Set-watermark" class="headerlink" title="Set watermark"></a>Set watermark</h3><figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;transient&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.disk.watermark.low&quot;</span>: <span class="string">&quot;80%&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.disk.watermark.high&quot;</span>: <span class="string">&quot;85%&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.disk.watermark.flood_stage&quot;</span>: <span class="string">&quot;90%&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET _cluster/settings</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Check-thread"><a href="#Check-thread" class="headerlink" title="Check thread"></a>Check thread</h3><figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">GET _cat/thread_pool?v</span><br><span class="line">GET _nodes/hot_threads</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Get-pipeline-info"><a href="#Get-pipeline-info" class="headerlink" title="Get pipeline info"></a>Get pipeline info</h3><figure class="highlight rust"><figcaption><span>dev_tools</span></figcaption><table><tr><td class="code"><pre><span class="line">GET _ingest/pipeline/filebeat-<span class="number">7</span>*</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>ELK</tag>
        <tag>API</tag>
        <tag>Elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearch、Kibana、Beats 和 Logstash 的安全設定</title>
    <url>/2020/11/10/Elasticsearch%E3%80%81Kibana%E3%80%81Beats-%E5%92%8C-Logstash-%E7%9A%84%E5%AE%89%E5%85%A8%E8%A8%AD%E5%AE%9A/</url>
    <content><![CDATA[<h1 id="x1f510-Elasticsearch、Kibana、Beats-和-Logstash-的安全設定"><a href="#x1f510-Elasticsearch、Kibana、Beats-和-Logstash-的安全設定" class="headerlink" title="&#x1f510;Elasticsearch、Kibana、Beats 和 Logstash 的安全設定"></a><center><span class="github-emoji" alias="closed_lock_with_key" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f510.png?v8">&#x1f510;</span>Elasticsearch、Kibana、Beats 和 Logstash 的安全設定</center></h1><h6 id="tags-ELK-beats-security-SSL-TLS"><a href="#tags-ELK-beats-security-SSL-TLS" class="headerlink" title="tags: ELK, beats, security , SSL , TLS"></a>tags: <code>ELK</code>, <code>beats</code>, <code>security</code> , <code>SSL</code> , <code>TLS</code></h6><h3 id="0-了解ELK-Xpack-amp-安全模式"><a href="#0-了解ELK-Xpack-amp-安全模式" class="headerlink" title="0. 了解ELK_Xpack &amp; 安全模式"></a>0. 了解ELK_Xpack &amp; 安全模式</h3><ul>
<li>Xpack<blockquote>
<p>X-Pack is an Elastic Stack extension that provides security, alerting, monitoring, reporting, machine learning, and many other capabilities.</p>
</blockquote>
</li>
</ul>
<p>ELK是有收費版本的 而Xpack部分功能只有付費才開放<br>請參考：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9zdWJzY3JpcHRpb25z">X-Pack features<i class="fa fa-external-link-alt"></i></span></p>
<ul>
<li>ELK叢集安全模式<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">＃ES設定中加入</span> <span class="string">就是開啟xpack</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<div class="note info"><h4 id="重要觀念"><a href="#重要觀念" class="headerlink" title="重要觀念:"></a>重要觀念:</h4><p>誰對誰 誰是server端 誰是client要分清楚<br>一個服務可能又是server又是client</p>
</div>

</li>
</ul>
<a id="more"></a>

<h3 id="1-使用憑證產生工具為每個es-node-產生憑證"><a href="#1-使用憑證產生工具為每個es-node-產生憑證" class="headerlink" title="1. 使用憑證產生工具為每個es_node 產生憑證"></a>1. 使用憑證產生工具為每個es_node 產生憑證</h3><ul>
<li>利用工具產生憑證（也可以用openssl指令）<div class="note primary"><h4 id="openssl-ex"><a href="#openssl-ex" class="headerlink" title="openssl ex:"></a>openssl ex:</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl ecparam -out ELK.key -name prime256v1 -genkey</span><br><span class="line">openssl req -new -sha256 -key ELK.key -out ELK.csr</span><br><span class="line">openssl x509 -req -sha256 -days 3650 -<span class="keyword">in</span> ELK.csr -signkey ELK.key -out ELK.crt</span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out ELK.ca.p12 -inkey ELK.key -<span class="keyword">in</span> ELK.crt</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h4 id="產生CA"><a href="#產生CA" class="headerlink" title="產生CA"></a>產生CA</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-certutil ca</span><br></pre></td></tr></table></figure>
<h4 id="產生各ES憑證串自簽的CA-是否加密碼-綁定域名-IP-關係後續驗證方式"><a href="#產生各ES憑證串自簽的CA-是否加密碼-綁定域名-IP-關係後續驗證方式" class="headerlink" title="產生各ES憑證串自簽的CA (是否加密碼,綁定域名,IP 關係後續驗證方式)"></a>產生各ES憑證串自簽的CA (是否加密碼,綁定域名,IP 關係後續驗證方式)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-certutil cert --ca /path/to/elastic-stack-ca.p12</span><br></pre></td></tr></table></figure>
<h4 id="產生http-ssl-是否加密碼-綁定域名-IP-關係後續驗證方式"><a href="#產生http-ssl-是否加密碼-綁定域名-IP-關係後續驗證方式" class="headerlink" title="產生http_ssl (是否加密碼,綁定域名,IP 關係後續驗證方式)"></a>產生http_ssl (是否加密碼,綁定域名,IP 關係後續驗證方式)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-certutil http --ca /path/to/elastic-stack-ca.p12</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Ref: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9tYXN0ZXIvY29uZmlndXJpbmctdGxzLmh0bWwjdGxzLWh0dHA=">Encrypting HTTP client communicationsedit<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<h3 id="2-設定每個es-node的憑證："><a href="#2-設定每個es-node的憑證：" class="headerlink" title="2. 設定每個es_node的憑證："></a>2. 設定<code>每個</code>es_node的憑證：</h3><ul>
<li><p><input checked="" disabled="" type="checkbox">  TLS (transport 9300)</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  SSL (http 9200)</p>
</li>
<li><p>Elasticsearch Coordinating node config </p>
<figure class="highlight yml"><figcaption><span>/etc/elasticsearch/elasticsearch.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-2</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-3</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-4</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-5</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-6</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">es-cluster-jp</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.47</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.48</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.49</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.50</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.51</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.52</span><span class="string">:9300</span></span><br><span class="line"><span class="attr">gateway.recover_after_data_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#listen interface</span></span><br><span class="line"><span class="attr">network.bind_host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment">#溝通網段</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.247</span></span><br><span class="line"><span class="attr">node.attr.rack:</span> <span class="string">r1</span></span><br><span class="line"><span class="comment">#宣告這個node的作用 請參照 ↓</span></span><br><span class="line"><span class="comment">##https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">jp-tribe-node</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"><span class="comment">#安全性開關 不然預設ELK是完全沒有安全保護 ↓</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#transport.ssl(9300)驗證方式 有certificate,none,full(域名＋IP+憑證) ↓</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"><span class="comment">#這邊是http.ssl(9200)驗證用 ↓</span></span><br><span class="line"><span class="comment"># This turns on SSL for the HTTP (Rest) interface</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.client_authentication:</span> <span class="string">optional</span></span><br><span class="line"><span class="comment"># This configures the keystore to use for SSL on HTTP</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">&quot;http.p12&quot;</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.truststore.path:</span> <span class="string">&quot;http.p12&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################### Paths ####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to directory containing configuration (this file and logging.yml):</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/var/lib/elasticsearch</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/elasticsearch</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Elasticsearch Master-node-1 config</p>
<figure class="highlight yml"><figcaption><span>/etc/elasticsearch/elasticsearch.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-2</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-3</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-4</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-5</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-6</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">es-cluster-jp</span></span><br><span class="line"><span class="comment">#這裡各台有所不同 ↓</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.247</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.48</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.49</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.50</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.51</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.52</span><span class="string">:9300</span></span><br><span class="line"><span class="attr">gateway.recover_after_data_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#根據角色不同監聽的位置有所不同增加安全性 ↓</span></span><br><span class="line"><span class="attr">network.bind_host:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">_local_</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.47</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.47</span></span><br><span class="line"><span class="attr">node.attr.rack:</span> <span class="string">r1</span></span><br><span class="line"><span class="comment">#角色不同設定不同 ↓</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">jp-node-1</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">full</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################### Paths ####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to directory containing configuration (this file and logging.yml):</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/var/lib/elasticsearch</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/elasticsearch</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="設定完畢記得重啟服務"><a href="#設定完畢記得重啟服務" class="headerlink" title="設定完畢記得重啟服務"></a>設定完畢記得重啟服務</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart elasticsearch</span><br></pre></td></tr></table></figure>

<div class="note "><h4 id="有關ES服務滾動式升級-x1f573"><a href="#有關ES服務滾動式升級-x1f573" class="headerlink" title="有關ES服務滾動式升級&#x1f573;"></a>有關ES服務滾動式升級<span class="github-emoji" alias="hole" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f573.png?v8">&#x1f573;</span></h4><blockquote>
<p><span class="github-emoji" alias="secret" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/3299.png?v8">&#x3299;</span><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3JvbGxpbmctdXBncmFkZXMuaHRtbA==">Rolling upgrade<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
</div>

<h3 id="3-設定監控-跟-帳密"><a href="#3-設定監控-跟-帳密" class="headerlink" title="3. 設定監控 跟 帳密"></a>3. 設定監控 跟 帳密</h3><ul>
<li><p>帳密設定</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 互動式</span></span><br><span class="line">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自動產生</span></span><br><span class="line">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>密碼生出來後，就把帳號密碼收好，等等會用到。之後初次登入也是使用這些密碼</p>
</li>
<li><p>監控設定</p>
</li>
</ul>
<p><i class="fa fa-toggle-on fa-fw"></i> legacy collectors<br>Kibana ES 內建都有開啟 不用特別設定 logstash 要開啟Xpack設定監控(因為要開監控帳號)</p>
<ul>
<li>kibana,ES內建開啟legacy collectors 無須設定</li>
<li>logstash <a href="#5-%E8%A8%AD%E5%AE%9A-Logstash">說明在下方設定lgostash處</a></li>
</ul>
<p><i class="fa fa-toggle-off fa-fw"></i> Metricbeat</p>
<blockquote>
<p>目前還是用<code>legacy collectors</code>監控所以這個請當參考用<br>官方推薦用<code>metricbeat</code>來監控 等到不支援時就要改這個<br><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlY3VyZS1tb25pdG9yaW5nLmh0bWw=">https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-monitoring.html<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<h3 id="4-設定-Kibana"><a href="#4-設定-Kibana" class="headerlink" title="4. 設定 Kibana"></a>4. 設定 Kibana</h3><p>Configure passwords on client-side(keystore)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/kibana/bin/kibana-keystore create</span><br><span class="line">/usr/share/kibana/bin/kibana-keystore add elasticsearch.username</span><br><span class="line">/usr/share/kibana/bin/kibana-keystore add elasticsearch.password</span><br></pre></td></tr></table></figure>
<p>kibana.yml</p>
<figure class="highlight yml"><figcaption><span>/etc/kibana/kibana.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">&quot;JP-Kibana.246:5601&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;https://192.168.9.247:9200&quot;</span>]</span><br><span class="line"><span class="attr">xpack.security.session.idleTimeout:</span> <span class="string">&quot;30m&quot;</span></span><br><span class="line"><span class="attr">xpack.security.session.lifespan:</span> <span class="string">&quot;8h&quot;</span></span><br><span class="line"><span class="attr">xpack.security.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="attr">xpack.encryptedSavedObjects.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="comment">#↓下面是kibana當server 瀏覽器client的憑證</span></span><br><span class="line"><span class="attr">server.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server.ssl.certificate:</span> <span class="string">&quot;/etc/kibana/cukgad.mis/cukgad.mis.crt&quot;</span></span><br><span class="line"><span class="attr">server.ssl.key:</span> <span class="string">&quot;/etc/kibana/cukgad.mis/cukgad.mis.key&quot;</span></span><br><span class="line"><span class="comment">#↓下面是kibana當client 到ES時需要的公鑰</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.certificateAuthorities:</span> <span class="string">&quot;/etc/kibana/elasticsearch-ca.pem&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.verificationMode:</span> <span class="string">full</span></span><br></pre></td></tr></table></figure>
<h3 id="5-設定-Logstash"><a href="#5-設定-Logstash" class="headerlink" title="5. 設定 Logstash"></a>5. 設定 Logstash</h3><h4 id="Configure-passwords-on-client-side-keystore"><a href="#Configure-passwords-on-client-side-keystore" class="headerlink" title="Configure passwords on client-side(keystore)"></a><code>Configure passwords on client-side(keystore)</code></h4><ul>
<li>logstash-keystore<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#比較不同的是logstash是java寫的 所以要用比較有點不同的方式加keystore</span></span><br><span class="line">$ <span class="built_in">set</span> +o <span class="built_in">history</span></span><br><span class="line">$ <span class="built_in">export</span> LOGSTASH_KEYSTORE_PASS=!QAZxsw2</span><br><span class="line">$ <span class="built_in">set</span> -o <span class="built_in">history</span></span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash create</span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LS_USER</span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LS_PWD</span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LW_USER</span><br><span class="line">$ sodu -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LW_PWD</span><br></pre></td></tr></table></figure></li>
<li>logstash.yml<figure class="highlight yml"><figcaption><span>/etc/logstash/logstash.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">path.data:</span> <span class="string">/var/lib/logstash</span></span><br><span class="line"><span class="attr">pipeline.ordered:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">config.reload.automatic:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">config.reload.interval:</span> <span class="string">15s</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/logstash</span></span><br><span class="line"><span class="attr">xpack.monitoring.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.username:</span> <span class="string">$&#123;LS_USER&#125;</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.password:</span> <span class="string">$&#123;LS_PWD&#125;</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.hosts:</span> [ <span class="string">&quot;https://10.20.30.247:9200&quot;</span> ]</span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.ssl.certificate_authority:</span> <span class="string">/etc/logstash/elasticsearch-ca.pem</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.ssl.verification_mode:</span> <span class="string">certificate</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight ruby"><figcaption><span>$LS_HOME/conf.d/output.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">    	user =&gt; <span class="string">&quot;$&#123;LW_USER&#125;&quot;</span></span><br><span class="line">    	password =&gt; <span class="string">&quot;$&#123;LW_PWD&#125;&quot;</span></span><br><span class="line">    	ssl =&gt; <span class="literal">true</span></span><br><span class="line">    	cacert =&gt; <span class="string">&quot;/etc/logstash/elasticsearch-ca.pem&quot;</span></span><br><span class="line">    	hosts =&gt; <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line">    	<span class="keyword">if</span> <span class="string">&quot;nginx&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">			<span class="keyword">if</span> [<span class="variable">@metadata</span>][pipeline] &#123;</span><br><span class="line">				<span class="comment">#manage_template =&gt; false</span></span><br><span class="line">				index =&gt; <span class="string">&quot;%&#123;[@metadata][beat]&#125;-%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">				pipeline =&gt; <span class="string">&quot;%&#123;[@metadata][pipeline]&#125;&quot;</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				manage_template =&gt; <span class="literal">false</span></span><br><span class="line">				ilm_enabled =&gt; <span class="literal">true</span></span><br><span class="line">				ilm_rollover_alias =&gt; <span class="string">&quot;nginx-log&quot;</span></span><br><span class="line">				<span class="comment">#ilm_pattern =&gt; &quot;&#123;now/d&#125;-000001&quot;</span></span><br><span class="line">				<span class="comment">#index =&gt; &quot;nginx-log-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;squid&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">			index =&gt; <span class="string">&quot;%&#123;[@metadata][beat]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;netscaler&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">	  		index =&gt; <span class="string">&quot;ns-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">	  	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;idrac&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        	index =&gt; <span class="string">&quot;idrac-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;pure&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">			index =&gt; <span class="string">&quot;pure-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;vmware&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">    		index =&gt; <span class="string">&quot;vmware-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    		index =&gt; <span class="string">&quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#  stdout &#123; codec =&gt; rubydebug &#125; </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="設定訪問帳號權限"><a href="#設定訪問帳號權限" class="headerlink" title="設定訪問帳號權限"></a><code>設定訪問帳號權限</code></h4><p>ES api 設定</p>
<ul>
<li><p>Internal Logstash User</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">POST /_security/role/logstash_writer</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;cluster&quot;</span>: [<span class="string">&quot;manage_index_templates&quot;</span>, <span class="string">&quot;monitor&quot;</span>, <span class="string">&quot;manage_ilm&quot;</span>], </span><br><span class="line">  <span class="string">&quot;indices&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;names&quot;</span>: [ <span class="string">&quot;logstash-*&quot;</span>, <span class="string">&quot;nginx-*&quot;</span>, <span class="string">&quot;filebeat-*&quot;</span>], </span><br><span class="line">      <span class="string">&quot;privileges&quot;</span>: [<span class="string">&quot;write&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;create_index&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;manage_ilm&quot;</span>]  </span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /_security/user/logstash_internal</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;password&quot;</span> : <span class="string">&quot;x-pack-test-password&quot;</span>,</span><br><span class="line">  <span class="string">&quot;roles&quot;</span> : [ <span class="string">&quot;logstash_writer&quot;</span>],</span><br><span class="line">  <span class="string">&quot;full_name&quot;</span> : <span class="string">&quot;Internal Logstash User&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Kibana User for Logstash</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">POST /_security/role/logstash_reader</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;indices&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;names&quot;</span>: [ <span class="string">&quot;logstash-*&quot;</span> ], </span><br><span class="line">      <span class="string">&quot;privileges&quot;</span>: [<span class="string">&quot;read&quot;</span>,<span class="string">&quot;view_index_metadata&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /_security/user/logstash_user</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;password&quot;</span> : <span class="string">&quot;x-pack-test-password&quot;</span>,</span><br><span class="line">  <span class="string">&quot;roles&quot;</span> : [ <span class="string">&quot;logstash_reader&quot;</span>, <span class="string">&quot;logstash_admin&quot;</span>], </span><br><span class="line">  <span class="string">&quot;full_name&quot;</span> : <span class="string">&quot;Kibana User for Logstash&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Kibana GUI 設定</p>
</li>
<li><p>待補</p>
</li>
</ul>
<h4 id="Logstash-Server端加密設定"><a href="#Logstash-Server端加密設定" class="headerlink" title="Logstash Server端加密設定"></a><code>Logstash Server端加密設定</code></h4><figure class="highlight ruby"><figcaption><span>$LS_HOME/conf.d/input.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">input &#123;   </span><br><span class="line">	beats &#123;</span><br><span class="line">    port =&gt; <span class="number">5044</span></span><br><span class="line">    host =&gt; <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    <span class="comment">#目前logsttash加密設定在這幾行 但目前沒加 因為加了各台beats要去裝公鑰</span></span><br><span class="line">    <span class="comment">#ssl =&gt; true</span></span><br><span class="line">    <span class="comment">#ssl_certificate =&gt; &#x27;/etc/logstash/certs/logstash.crt&#x27;</span></span><br><span class="line">    <span class="comment">#ssl_key =&gt; &#x27;/etc/logstash/certs/logstash.key&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  syslog &#123;</span><br><span class="line">    port =&gt; <span class="number">5041</span></span><br><span class="line">    type =&gt; syslog</span><br><span class="line">    tags =&gt; idrac</span><br><span class="line">  &#125;</span><br><span class="line">  syslog &#123;</span><br><span class="line">    port =&gt; <span class="number">5042</span></span><br><span class="line">    type =&gt; syslog</span><br><span class="line">    tags =&gt; pure</span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; <span class="number">5043</span></span><br><span class="line">    type =&gt; tcp</span><br><span class="line">    tags =&gt; netscaler</span><br><span class="line">  &#125;</span><br><span class="line">  udp &#123;</span><br><span class="line">    port =&gt; <span class="number">5043</span></span><br><span class="line">    type =&gt; udp</span><br><span class="line">    tags =&gt; netscaler</span><br><span class="line">  &#125;</span><br><span class="line">  syslog &#123;</span><br><span class="line">    port =&gt; <span class="number">1514</span></span><br><span class="line">    type =&gt; syslog</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">#  stdin &#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-設定-Beats"><a href="#6-設定-Beats" class="headerlink" title="6. 設定 Beats"></a>6. 設定 Beats</h3><ul>
<li>如果 beat 有設定送ES或logstash有設定加密就要做<ul>
<li><code>目前logstash沒有加密</code></li>
<li>ES 端待補充</li>
</ul>
</li>
</ul>
<p>Configure passwords on client-side</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/apm-server/bin/filebeat keystore create</span><br><span class="line">/usr/share/apm-server/bin/filebeat add elasticsearch.username</span><br><span class="line">/usr/share/apm-server/bin/filebeat add elasticsearch.password</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>Beats</tag>
        <tag>ELK</tag>
        <tag>Security</tag>
        <tag>SSL</tag>
        <tag>TLS</tag>
      </tags>
  </entry>
</search>
