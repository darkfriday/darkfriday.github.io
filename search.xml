<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Auditbeat_install@CentOS8</title>
    <url>/2020/11/10/Auditbeat-install/</url>
    <content><![CDATA[<h1 id="x1f4e6-Auditbeat-install-CentOS8"><a href="#x1f4e6-Auditbeat-install-CentOS8" class="headerlink" title="&#x1f4e6;Auditbeat_install@CentOS8 "></a><center><span class="github-emoji" alias="package" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4e6.png?v8">&#x1f4e6;</span>Auditbeat_install@CentOS8 </center></h1><h6 id="tags-dnf-beats-centos-el8"><a href="#tags-dnf-beats-centos-el8" class="headerlink" title="tags: dnf, beats, centos , el8"></a>tags: <code>dnf</code>, <code>beats</code>, <code>centos</code> , <code>el8</code></h6><h3 id="Download-elastic-repo-GPG-key"><a href="#Download-elastic-repo-GPG-key" class="headerlink" title="Download elastic repo GPG key"></a>Download elastic repo GPG key</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="Create-repo-in-etc-yum-repos-d"><a href="#Create-repo-in-etc-yum-repos-d" class="headerlink" title="Create .repo in /etc/yum.repos.d/"></a>Create <code>.repo</code> in <code>/etc/yum.repos.d/</code></h3><figure class="highlight plain"><figcaption><span>/etc/yum.repos.d/elastic.repo</span></figcaption><table><tr><td class="code"><pre><span class="line">[elastic-7.x]</span><br><span class="line">name&#x3D;Elastic repository for 7.x packages</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;packages&#x2F;7.x&#x2F;yum</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;artifacts.elastic.co&#x2F;GPG-KEY-elasticsearch</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">autorefresh&#x3D;1</span><br><span class="line">type&#x3D;rpm-md</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<ul>
<li>dnf install auditbeat<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf install auditbeat</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Configure-automatiically-during-boot"><a href="#Configure-automatiically-during-boot" class="headerlink" title="Configure automatiically during boot"></a>Configure automatiically during boot</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> auditbeat</span><br><span class="line">$ sudo systemctl start auditbeat</span><br></pre></td></tr></table></figure>
<h3 id="Modify-output-IP-address-amp-configure-mem-queue-size"><a href="#Modify-output-IP-address-amp-configure-mem-queue-size" class="headerlink" title="Modify output IP address &amp; configure mem queue size"></a>Modify output IP address &amp; configure mem queue size</h3><p>注意網段<code>.1</code> or <code>.2</code></p>
<div class="tabs" id="unique-name"><ul class="nav-tabs"><li class="tab active"><a href="#unique-name-1">.1網段</a></li><li class="tab"><a href="#unique-name-2">.2網段</a></li></ul><div class="tab-content"><div class="tab-pane active" id="unique-name-1"><figure class="highlight yaml"><figcaption><span>/etc/aduitbeat/aduitbeat.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.10.1.247:9200&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">queue.mem:</span></span><br><span class="line">  <span class="attr">events:</span> <span class="number">1024</span></span><br><span class="line">  <span class="attr">flush.min_events:</span> <span class="number">512</span></span><br><span class="line">  <span class="attr">flush.timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="unique-name-2"><figure class="highlight yaml"><figcaption><span>/etc/aduitbeat/aduitbeat.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.10.2.247:9200&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">queue.mem:</span></span><br><span class="line">  <span class="attr">events:</span> <span class="number">1024</span></span><br><span class="line">  <span class="attr">flush.min_events:</span> <span class="number">512</span></span><br><span class="line">  <span class="attr">flush.timeout:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure></div></div></div>

<p>Plus: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9iZWF0cy9hdWRpdGJlYXQvY3VycmVudC9ydW5uaW5nLW9uLWRvY2tlci5odG1s">Run auditbeat on Docker<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>Dnf</tag>
        <tag>Beats</tag>
        <tag>CentOS</tag>
        <tag>EL8</tag>
      </tags>
  </entry>
  <entry>
    <title>CoreDNS 安裝教學 in Centos8</title>
    <url>/2020/11/10/CoreDNS-%E5%AE%89%E8%A3%9D%E6%95%99%E5%AD%B8-in-Centos8-Docker/</url>
    <content><![CDATA[<h1 id="x2693-CoreDNS-安裝教學-in-Centos8-x1f433-Docker"><a href="#x2693-CoreDNS-安裝教學-in-Centos8-x1f433-Docker" class="headerlink" title="&#x2693;CoreDNS 安裝教學 in Centos8(&#x1f433;Docker)"></a><center><span class="github-emoji" alias="anchor" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2693.png?v8">&#x2693;</span>CoreDNS 安裝教學 in Centos8(<span class="github-emoji" alias="whale" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f433.png?v8">&#x1f433;</span>Docker)</center></h1><h6 id="tags-coreDNS-docker-centos-el8"><a href="#tags-coreDNS-docker-centos-el8" class="headerlink" title="tags: coreDNS docker centos el8"></a>tags: <code>coreDNS</code> <code>docker</code> <code>centos</code> <code>el8</code></h6><h2 id="安裝Docker"><a href="#安裝Docker" class="headerlink" title="安裝Docker"></a>安裝Docker</h2><ul>
<li><p><code>step 1</code> Add docker repo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 2</code> Installing docker-ce 相關依賴套件</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> buildah</li>
<li><input checked="" disabled="" type="checkbox"> podman</li>
<li><input disabled="" type="checkbox"> containerd.io &gt; 1.2.0-3.el7<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf -y install buildah &amp;&amp; dnf -y install podman</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><strong>step 2.5</strong> Manual Installing containerd.io</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">版本號 1.2.13-3.2 可更換最新的 </span><br><span class="line">$ sudo dnf -y install https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<a id="more"></a>
</li>
<li><p><code>step 3</code> Installing docker-ce</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo dnf -y install docker-ce</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>step 4</code> 關閉防火牆(會造成docker內部橋接網路不通)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 5</code> Start and enable the docker daemon</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">設定為daemon啟動</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> --now docker</span><br><span class="line"></span><br><span class="line">檢查是否啟動</span><br><span class="line">$ sudo systemctl is-active docker</span><br><span class="line"></span><br><span class="line">檢查是否自動啟動</span><br><span class="line">$ sudo systemctl is-enabled docker</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 6</code> Installing docker-compose（手動方式）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">下載可執行檔案 1.27.0-rc3 可更換最新的</span><br><span class="line">$ curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.27.0-rc3/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o docker-compose</span><br><span class="line">加可執行and傳到/usr/<span class="built_in">local</span>/bin底下</span><br><span class="line">$ sudo mv docker-compose /usr/<span class="built_in">local</span>/bin &amp;&amp; sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>:::info<br>==番外== testing docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker run --rm --name=linuxconfig-test -p 80:80 httpd </span><br><span class="line">如果成功用瀏覽器在自己的ip打開 會看到it<span class="string">&#x27;s work!</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker rmi httpd</span><br><span class="line">刪除測試用httpd</span><br></pre></td></tr></table></figure>
<p>:::</p>
</li>
</ul>
<h2 id="安裝CoreDNS"><a href="#安裝CoreDNS" class="headerlink" title="安裝CoreDNS"></a>安裝CoreDNS</h2><ul>
<li><p><code>step 1</code> dockerhub 上抓coredn的映像檔</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker pull coredns/coredns</span><br></pre></td></tr></table></figure></li>
<li><p><code>step 2</code> config coredns </p>
<ul>
<li><input checked="" disabled="" type="checkbox"> docker-compose.yml<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo mkdir -p docker/coredns/config &amp;&amp; <span class="built_in">cd</span> docker/coredns &amp;&amp; vim docker-compose.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">coredns:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">coredns/coredns:latest</span></span><br><span class="line">      <span class="attr">container_name:</span> <span class="string">coredns</span></span><br><span class="line">      <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">expose:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53/udp&#x27;</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53:53&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;53:53/udp&#x27;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;$PWD/config/:/etc/coredns/&#x27;</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;-conf&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;/etc/coredns/Corefile&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><input checked="" disabled="" type="checkbox"> Corefile<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vim config/Corefile</span><br></pre></td></tr></table></figure>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">.:<span class="number">53</span> &#123;</span><br><span class="line">    forward . <span class="number">8.8</span>.<span class="number">8.8</span>:<span class="number">53</span></span><br><span class="line">    <span class="built_in">log</span></span><br><span class="line">    errors</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mis &#123;</span><br><span class="line">    <span class="keyword">file</span> /etc/coredns/mis</span><br><span class="line">    <span class="built_in">log</span></span><br><span class="line">    errors</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><input checked="" disabled="" type="checkbox"> mis<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vim config/mis</span><br></pre></td></tr></table></figure>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line"><span class="meta">$TTL</span> <span class="number">10</span></span><br><span class="line">@     <span class="keyword">IN</span>  <span class="keyword">SOA</span>     ns1.service. root.ns.service. (</span><br><span class="line">            <span class="number">2</span>   <span class="comment">;serial</span></span><br><span class="line">            <span class="number">300</span> <span class="comment">; refresh</span></span><br><span class="line">            <span class="number">1800</span> <span class="comment">; retry</span></span><br><span class="line">            <span class="number">10</span>  <span class="comment">; expire</span></span><br><span class="line">            <span class="number">300</span> <span class="comment">; minimum</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">;name servers</span></span><br><span class="line">@       <span class="keyword">IN</span>      <span class="keyword">NS</span>      ns1.service.</span><br><span class="line">ns1.service.    <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">10.20.10.246</span></span><br><span class="line">vcsa   <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.200</span></span><br><span class="line">esxi201 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.201</span></span><br><span class="line">esxi202 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.202</span></span><br><span class="line">esxi203 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.203</span></span><br><span class="line">esxi204 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.204</span></span><br><span class="line">esxi205 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.205</span></span><br><span class="line">esxi206 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.206</span></span><br><span class="line">esxi207 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.207</span></span><br><span class="line">esxi208 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.208</span></span><br><span class="line">esxi209 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.209</span></span><br><span class="line">esxi210 <span class="keyword">IN</span> <span class="keyword">A</span> <span class="number">192.168.9.210</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>step 3</code> Run docker-compose </p>
</li>
</ul>
<p>enable</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>restart</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo docker-compose restart coredns</span><br><span class="line">or</span><br><span class="line">$ sudo docker restart coredns</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>CentOS</tag>
        <tag>EL8</tag>
        <tag>Docker</tag>
        <tag>Coredns</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearch、Kibana、Beats 和 Logstash 的安全設定</title>
    <url>/2020/11/10/Elasticsearch%E3%80%81Kibana%E3%80%81Beats-%E5%92%8C-Logstash-%E7%9A%84%E5%AE%89%E5%85%A8%E8%A8%AD%E5%AE%9A/</url>
    <content><![CDATA[<h1 id="x1f510-Elasticsearch、Kibana、Beats-和-Logstash-的安全設定"><a href="#x1f510-Elasticsearch、Kibana、Beats-和-Logstash-的安全設定" class="headerlink" title="&#x1f510;Elasticsearch、Kibana、Beats 和 Logstash 的安全設定"></a><center><span class="github-emoji" alias="closed_lock_with_key" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f510.png?v8">&#x1f510;</span>Elasticsearch、Kibana、Beats 和 Logstash 的安全設定</center></h1><h6 id="tags-ELK-beats-security-SSL-TLS"><a href="#tags-ELK-beats-security-SSL-TLS" class="headerlink" title="tags: ELK, beats, security , SSL , TLS"></a>tags: <code>ELK</code>, <code>beats</code>, <code>security</code> , <code>SSL</code> , <code>TLS</code></h6><h3 id="0-了解ELK-Xpack-amp-安全模式"><a href="#0-了解ELK-Xpack-amp-安全模式" class="headerlink" title="0. 了解ELK_Xpack &amp; 安全模式"></a>0. 了解ELK_Xpack &amp; 安全模式</h3><ul>
<li>Xpack<blockquote>
<p>X-Pack is an Elastic Stack extension that provides security, alerting, monitoring, reporting, machine learning, and many other capabilities.</p>
</blockquote>
</li>
</ul>
<p>ELK是有收費版本的 而Xpack部分功能只有付費才開放<br>請參考：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9zdWJzY3JpcHRpb25z">X-Pack features<i class="fa fa-external-link-alt"></i></span></p>
<ul>
<li>ELK叢集安全模式<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">＃ES設定中加入</span> <span class="string">就是開啟xpack</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<div class="note info"><h4 id="重要觀念"><a href="#重要觀念" class="headerlink" title="重要觀念:"></a>重要觀念:</h4><p>誰對誰 誰是server端 誰是client要分清楚<br>一個服務可能又是server又是client</p>
</div>

</li>
</ul>
<a id="more"></a>

<h3 id="1-使用憑證產生工具為每個es-node-產生憑證"><a href="#1-使用憑證產生工具為每個es-node-產生憑證" class="headerlink" title="1. 使用憑證產生工具為每個es_node 產生憑證"></a>1. 使用憑證產生工具為每個es_node 產生憑證</h3><ul>
<li>利用工具產生憑證（也可以用openssl指令）<div class="note primary"><h4 id="openssl-ex"><a href="#openssl-ex" class="headerlink" title="openssl ex:"></a>openssl ex:</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl ecparam -out ELK.key -name prime256v1 -genkey</span><br><span class="line">openssl req -new -sha256 -key ELK.key -out ELK.csr</span><br><span class="line">openssl x509 -req -sha256 -days 3650 -<span class="keyword">in</span> ELK.csr -signkey ELK.key -out ELK.crt</span><br><span class="line">openssl pkcs12 -<span class="built_in">export</span> -out ELK.ca.p12 -inkey ELK.key -<span class="keyword">in</span> ELK.crt</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h4 id="產生CA"><a href="#產生CA" class="headerlink" title="產生CA"></a>產生CA</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-certutil ca</span><br></pre></td></tr></table></figure>
<h4 id="產生各ES憑證串自簽的CA-是否加密碼-綁定域名-IP-關係後續驗證方式"><a href="#產生各ES憑證串自簽的CA-是否加密碼-綁定域名-IP-關係後續驗證方式" class="headerlink" title="產生各ES憑證串自簽的CA (是否加密碼,綁定域名,IP 關係後續驗證方式)"></a>產生各ES憑證串自簽的CA (是否加密碼,綁定域名,IP 關係後續驗證方式)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-certutil cert --ca /path/to/elastic-stack-ca.p12</span><br></pre></td></tr></table></figure>
<h4 id="產生http-ssl-是否加密碼-綁定域名-IP-關係後續驗證方式"><a href="#產生http-ssl-是否加密碼-綁定域名-IP-關係後續驗證方式" class="headerlink" title="產生http_ssl (是否加密碼,綁定域名,IP 關係後續驗證方式)"></a>產生http_ssl (是否加密碼,綁定域名,IP 關係後續驗證方式)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/elasticsearch/bin/elasticsearch-certutil http --ca /path/to/elastic-stack-ca.p12</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Ref: <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9tYXN0ZXIvY29uZmlndXJpbmctdGxzLmh0bWwjdGxzLWh0dHA=">Encrypting HTTP client communicationsedit<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<h3 id="2-設定每個es-node的憑證："><a href="#2-設定每個es-node的憑證：" class="headerlink" title="2. 設定每個es_node的憑證："></a>2. 設定<code>每個</code>es_node的憑證：</h3><ul>
<li><p><input checked="" disabled="" type="checkbox">  TLS (transport 9300)</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  SSL (http 9200)</p>
</li>
<li><p>Elasticsearch Coordinating node config </p>
<figure class="highlight yml"><figcaption><span>/etc/elasticsearch/elasticsearch.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-2</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-3</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-4</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-5</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-6</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">es-cluster-jp</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.47</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.48</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.49</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.50</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.51</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.52</span><span class="string">:9300</span></span><br><span class="line"><span class="attr">gateway.recover_after_data_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#listen interface</span></span><br><span class="line"><span class="attr">network.bind_host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="comment">#溝通網段</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.247</span></span><br><span class="line"><span class="attr">node.attr.rack:</span> <span class="string">r1</span></span><br><span class="line"><span class="comment">#宣告這個node的作用 請參照 ↓</span></span><br><span class="line"><span class="comment">##https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">jp-tribe-node</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"><span class="comment">#安全性開關 不然預設ELK是完全沒有安全保護 ↓</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#transport.ssl(9300)驗證方式 有certificate,none,full(域名＋IP+憑證) ↓</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">certificate</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"><span class="comment">#這邊是http.ssl(9200)驗證用 ↓</span></span><br><span class="line"><span class="comment"># This turns on SSL for the HTTP (Rest) interface</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.client_authentication:</span> <span class="string">optional</span></span><br><span class="line"><span class="comment"># This configures the keystore to use for SSL on HTTP</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.keystore.path:</span> <span class="string">&quot;http.p12&quot;</span></span><br><span class="line"><span class="attr">xpack.security.http.ssl.truststore.path:</span> <span class="string">&quot;http.p12&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################### Paths ####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to directory containing configuration (this file and logging.yml):</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/var/lib/elasticsearch</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/elasticsearch</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Elasticsearch Master-node-1 config</p>
<figure class="highlight yml"><figcaption><span>/etc/elasticsearch/elasticsearch.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cluster.initial_master_nodes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-2</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-3</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-4</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-5</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">jp-node-6</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">es-cluster-jp</span></span><br><span class="line"><span class="comment">#這裡各台有所不同 ↓</span></span><br><span class="line"><span class="attr">discovery.seed_hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.247</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.48</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.49</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.50</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.51</span><span class="string">:9300</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.52</span><span class="string">:9300</span></span><br><span class="line"><span class="attr">gateway.recover_after_data_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="comment">#根據角色不同監聽的位置有所不同增加安全性 ↓</span></span><br><span class="line"><span class="attr">network.bind_host:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">_local_</span></span><br><span class="line"><span class="bullet">-</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.47</span></span><br><span class="line"><span class="attr">network.publish_host:</span> <span class="number">10.20</span><span class="number">.30</span><span class="number">.47</span></span><br><span class="line"><span class="attr">node.attr.rack:</span> <span class="string">r1</span></span><br><span class="line"><span class="comment">#角色不同設定不同 ↓</span></span><br><span class="line"><span class="attr">node.data:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.ingest:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">jp-node-1</span></span><br><span class="line"><span class="attr">transport.port:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">xpack.security.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.verification_mode:</span> <span class="string">full</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.keystore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"><span class="attr">xpack.security.transport.ssl.truststore.path:</span> <span class="string">/etc/elasticsearch/elastic.ca/$&#123;node.name&#125;.p12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################### Paths ####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to directory containing configuration (this file and logging.yml):</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">/var/lib/elasticsearch</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/elasticsearch</span></span><br><span class="line"><span class="attr">action.auto_create_index:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="設定完畢記得重啟服務"><a href="#設定完畢記得重啟服務" class="headerlink" title="設定完畢記得重啟服務"></a>設定完畢記得重啟服務</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart elasticsearch</span><br></pre></td></tr></table></figure>

<div class="note "><h4 id="有關ES服務滾動式升級-x1f573"><a href="#有關ES服務滾動式升級-x1f573" class="headerlink" title="有關ES服務滾動式升級&#x1f573;"></a>有關ES服務滾動式升級<span class="github-emoji" alias="hole" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f573.png?v8">&#x1f573;</span></h4><blockquote>
<p><span class="github-emoji" alias="secret" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/3299.png?v8">&#x3299;</span><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3JvbGxpbmctdXBncmFkZXMuaHRtbA==">Rolling upgrade<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
</div>

<h3 id="3-設定監控-跟-帳密"><a href="#3-設定監控-跟-帳密" class="headerlink" title="3. 設定監控 跟 帳密"></a>3. 設定監控 跟 帳密</h3><ul>
<li><p>帳密設定</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 互動式</span></span><br><span class="line">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自動產生</span></span><br><span class="line">/usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>密碼生出來後，就把帳號密碼收好，等等會用到。之後初次登入也是使用這些密碼</p>
</li>
<li><p>監控設定</p>
</li>
</ul>
<p><i class="fa fa-toggle-on fa-fw"></i> legacy collectors<br>Kibana ES 內建都有開啟 不用特別設定 logstash 要開啟Xpack設定監控(因為要開監控帳號)</p>
<ul>
<li>kibana,ES內建開啟legacy collectors 無須設定</li>
<li>logstash <a href="#5-%E8%A8%AD%E5%AE%9A-Logstash">說明在下方設定lgostash處</a></li>
</ul>
<p><i class="fa fa-toggle-off fa-fw"></i> Metricbeat</p>
<blockquote>
<p>目前還是用<code>legacy collectors</code>監控所以這個請當參考用<br>官方推薦用<code>metricbeat</code>來監控 等到不支援時就要改這個<br><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9lbGFzdGljc2VhcmNoL3JlZmVyZW5jZS9jdXJyZW50L3NlY3VyZS1tb25pdG9yaW5nLmh0bWw=">https://www.elastic.co/guide/en/elasticsearch/reference/current/secure-monitoring.html<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<h3 id="4-設定-Kibana"><a href="#4-設定-Kibana" class="headerlink" title="4. 設定 Kibana"></a>4. 設定 Kibana</h3><p>Configure passwords on client-side(keystore)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/kibana/bin/kibana-keystore create</span><br><span class="line">/usr/share/kibana/bin/kibana-keystore add elasticsearch.username</span><br><span class="line">/usr/share/kibana/bin/kibana-keystore add elasticsearch.password</span><br></pre></td></tr></table></figure>
<p>kibana.yml</p>
<figure class="highlight yml"><figcaption><span>/etc/kibana/kibana.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">&quot;JP-Kibana.246:5601&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [<span class="string">&quot;https://192.168.9.247:9200&quot;</span>]</span><br><span class="line"><span class="attr">xpack.security.session.idleTimeout:</span> <span class="string">&quot;30m&quot;</span></span><br><span class="line"><span class="attr">xpack.security.session.lifespan:</span> <span class="string">&quot;8h&quot;</span></span><br><span class="line"><span class="attr">xpack.security.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="attr">xpack.encryptedSavedObjects.encryptionKey:</span> <span class="string">&quot;something_at_least_32_characters&quot;</span></span><br><span class="line"><span class="comment">#↓下面是kibana當server 瀏覽器client的憑證</span></span><br><span class="line"><span class="attr">server.ssl.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server.ssl.certificate:</span> <span class="string">&quot;/etc/kibana/cukgad.mis/cukgad.mis.crt&quot;</span></span><br><span class="line"><span class="attr">server.ssl.key:</span> <span class="string">&quot;/etc/kibana/cukgad.mis/cukgad.mis.key&quot;</span></span><br><span class="line"><span class="comment">#↓下面是kibana當client 到ES時需要的公鑰</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.certificateAuthorities:</span> <span class="string">&quot;/etc/kibana/elasticsearch-ca.pem&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.ssl.verificationMode:</span> <span class="string">full</span></span><br></pre></td></tr></table></figure>
<h3 id="5-設定-Logstash"><a href="#5-設定-Logstash" class="headerlink" title="5. 設定 Logstash"></a>5. 設定 Logstash</h3><h4 id="Configure-passwords-on-client-side-keystore"><a href="#Configure-passwords-on-client-side-keystore" class="headerlink" title="Configure passwords on client-side(keystore)"></a><code>Configure passwords on client-side(keystore)</code></h4><ul>
<li>logstash-keystore<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#比較不同的是logstash是java寫的 所以要用比較有點不同的方式加keystore</span></span><br><span class="line">$ <span class="built_in">set</span> +o <span class="built_in">history</span></span><br><span class="line">$ <span class="built_in">export</span> LOGSTASH_KEYSTORE_PASS=!QAZxsw2</span><br><span class="line">$ <span class="built_in">set</span> -o <span class="built_in">history</span></span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash create</span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LS_USER</span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LS_PWD</span><br><span class="line">$ sudo -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LW_USER</span><br><span class="line">$ sodu -E /usr/share/logstash/bin/logstash-keystore --path.settings /etc/logstash add LW_PWD</span><br></pre></td></tr></table></figure></li>
<li>logstash.yml<figure class="highlight yml"><figcaption><span>/etc/logstash/logstash.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">path.data:</span> <span class="string">/var/lib/logstash</span></span><br><span class="line"><span class="attr">pipeline.ordered:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">config.reload.automatic:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">config.reload.interval:</span> <span class="string">15s</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/logstash</span></span><br><span class="line"><span class="attr">xpack.monitoring.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.username:</span> <span class="string">$&#123;LS_USER&#125;</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.password:</span> <span class="string">$&#123;LS_PWD&#125;</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.hosts:</span> [ <span class="string">&quot;https://10.20.30.247:9200&quot;</span> ]</span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.ssl.certificate_authority:</span> <span class="string">/etc/logstash/elasticsearch-ca.pem</span></span><br><span class="line"><span class="attr">xpack.monitoring.elasticsearch.ssl.verification_mode:</span> <span class="string">certificate</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight ruby"><figcaption><span>$LS_HOME/conf.d/output.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">    	user =&gt; <span class="string">&quot;$&#123;LW_USER&#125;&quot;</span></span><br><span class="line">    	password =&gt; <span class="string">&quot;$&#123;LW_PWD&#125;&quot;</span></span><br><span class="line">    	ssl =&gt; <span class="literal">true</span></span><br><span class="line">    	cacert =&gt; <span class="string">&quot;/etc/logstash/elasticsearch-ca.pem&quot;</span></span><br><span class="line">    	hosts =&gt; <span class="string">&quot;http://localhost:9200&quot;</span></span><br><span class="line">    	<span class="keyword">if</span> <span class="string">&quot;nginx&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">			<span class="keyword">if</span> [@metadata][pipeline] &#123;</span><br><span class="line">				<span class="comment">#manage_template =&gt; false</span></span><br><span class="line">				index =&gt; <span class="string">&quot;%&#123;[@metadata][beat]&#125;-%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">				pipeline =&gt; <span class="string">&quot;%&#123;[@metadata][pipeline]&#125;&quot;</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				manage_template =&gt; <span class="literal">false</span></span><br><span class="line">				ilm_enabled =&gt; <span class="literal">true</span></span><br><span class="line">				ilm_rollover_alias =&gt; <span class="string">&quot;nginx-log&quot;</span></span><br><span class="line">				<span class="comment">#ilm_pattern =&gt; &quot;&#123;now/d&#125;-000001&quot;</span></span><br><span class="line">				<span class="comment">#index =&gt; &quot;nginx-log-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;squid&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">			index =&gt; <span class="string">&quot;%&#123;[@metadata][beat]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;netscaler&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">	  		index =&gt; <span class="string">&quot;ns-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">	  	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;idrac&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        	index =&gt; <span class="string">&quot;idrac-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;pure&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">			index =&gt; <span class="string">&quot;pure-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;vmware&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">    		index =&gt; <span class="string">&quot;vmware-syslog-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    		index =&gt; <span class="string">&quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#  stdout &#123; codec =&gt; rubydebug &#125; </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="設定訪問帳號權限"><a href="#設定訪問帳號權限" class="headerlink" title="設定訪問帳號權限"></a><code>設定訪問帳號權限</code></h4><p>ES api 設定</p>
<ul>
<li><p>Internal Logstash User</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">POST /_security/role/logstash_writer</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;cluster&quot;</span>: [<span class="string">&quot;manage_index_templates&quot;</span>, <span class="string">&quot;monitor&quot;</span>, <span class="string">&quot;manage_ilm&quot;</span>], </span><br><span class="line">  <span class="string">&quot;indices&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;names&quot;</span>: [ <span class="string">&quot;logstash-*&quot;</span>, <span class="string">&quot;nginx-*&quot;</span>, <span class="string">&quot;filebeat-*&quot;</span>], </span><br><span class="line">      <span class="string">&quot;privileges&quot;</span>: [<span class="string">&quot;write&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;create_index&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;manage_ilm&quot;</span>]  </span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /_security/user/logstash_internal</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;password&quot;</span> : <span class="string">&quot;x-pack-test-password&quot;</span>,</span><br><span class="line">  <span class="string">&quot;roles&quot;</span> : [ <span class="string">&quot;logstash_writer&quot;</span>],</span><br><span class="line">  <span class="string">&quot;full_name&quot;</span> : <span class="string">&quot;Internal Logstash User&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Kibana User for Logstash</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">POST /_security/role/logstash_reader</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;indices&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;names&quot;</span>: [ <span class="string">&quot;logstash-*&quot;</span> ], </span><br><span class="line">      <span class="string">&quot;privileges&quot;</span>: [<span class="string">&quot;read&quot;</span>,<span class="string">&quot;view_index_metadata&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /_security/user/logstash_user</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;password&quot;</span> : <span class="string">&quot;x-pack-test-password&quot;</span>,</span><br><span class="line">  <span class="string">&quot;roles&quot;</span> : [ <span class="string">&quot;logstash_reader&quot;</span>, <span class="string">&quot;logstash_admin&quot;</span>], </span><br><span class="line">  <span class="string">&quot;full_name&quot;</span> : <span class="string">&quot;Kibana User for Logstash&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Kibana GUI 設定</p>
</li>
<li><p>待補</p>
</li>
</ul>
<h4 id="Logstash-Server端加密設定"><a href="#Logstash-Server端加密設定" class="headerlink" title="Logstash Server端加密設定"></a><code>Logstash Server端加密設定</code></h4><figure class="highlight ruby"><figcaption><span>$LS_HOME/conf.d/input.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">input &#123;   </span><br><span class="line">	beats &#123;</span><br><span class="line">    port =&gt; <span class="number">5044</span></span><br><span class="line">    host =&gt; <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    <span class="comment">#目前logsttash加密設定在這幾行 但目前沒加 因為加了各台beats要去裝公鑰</span></span><br><span class="line">    <span class="comment">#ssl =&gt; true</span></span><br><span class="line">    <span class="comment">#ssl_certificate =&gt; &#x27;/etc/logstash/certs/logstash.crt&#x27;</span></span><br><span class="line">    <span class="comment">#ssl_key =&gt; &#x27;/etc/logstash/certs/logstash.key&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  syslog &#123;</span><br><span class="line">    port =&gt; <span class="number">5041</span></span><br><span class="line">    type =&gt; syslog</span><br><span class="line">    tags =&gt; idrac</span><br><span class="line">  &#125;</span><br><span class="line">  syslog &#123;</span><br><span class="line">    port =&gt; <span class="number">5042</span></span><br><span class="line">    type =&gt; syslog</span><br><span class="line">    tags =&gt; pure</span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; <span class="number">5043</span></span><br><span class="line">    type =&gt; tcp</span><br><span class="line">    tags =&gt; netscaler</span><br><span class="line">  &#125;</span><br><span class="line">  udp &#123;</span><br><span class="line">    port =&gt; <span class="number">5043</span></span><br><span class="line">    type =&gt; udp</span><br><span class="line">    tags =&gt; netscaler</span><br><span class="line">  &#125;</span><br><span class="line">  syslog &#123;</span><br><span class="line">    port =&gt; <span class="number">1514</span></span><br><span class="line">    type =&gt; syslog</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">#  stdin &#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-設定-Beats"><a href="#6-設定-Beats" class="headerlink" title="6. 設定 Beats"></a>6. 設定 Beats</h3><ul>
<li>如果 beat 有設定送ES或logstash有設定加密就要做<ul>
<li><code>目前logstash沒有加密</code></li>
<li>ES 端待補充</li>
</ul>
</li>
</ul>
<p>Configure passwords on client-side</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/share/apm-server/bin/filebeat keystore create</span><br><span class="line">/usr/share/apm-server/bin/filebeat add elasticsearch.username</span><br><span class="line">/usr/share/apm-server/bin/filebeat add elasticsearch.password</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>Beats</tag>
        <tag>ELK</tag>
        <tag>Security</tag>
        <tag>SSL</tag>
        <tag>TLS</tag>
      </tags>
  </entry>
</search>
